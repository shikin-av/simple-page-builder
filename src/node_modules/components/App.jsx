import React from 'react'
import 'typeface-roboto'
import { withStyles } from '@material-ui/core/styles'
import { MuiThemeProvider, createMuiTheme } from '@material-ui/core/styles'
import _ from 'lodash'

import grey from '@material-ui/core/colors/grey'
import CssBaseline from '@material-ui/core/CssBaseline'

//import Tools from 'components/Tools'
import Row from 'components/Row'
import rowTypes from 'components/rows'

import fake from 'components/fake'

class App extends React.Component {
    state = {
        mode: 'edit',
        isShowTools: false,
        rows: fake,
    }

    onShowTools = val => {
        this.setState({isShowTools: val})
    }

    addRow = ({type, id}) => {
        const {rows} = this.state
        const prevRowId = id
        
        const prevRowIndex = _.findIndex(rows, row => {
            return row.id === prevRowId
        })
        if(prevRowIndex !== -1){
            const prevRows = _.take(rows, prevRowIndex + 1)                
            const nextRows = _.difference(rows, prevRows)
            prevRows.push({
                id: Math.random(),
                type: type,
                elements: []
            })
            const resultRows = _.concat(prevRows, nextRows)            
            this.setState({
                isShowTools: false,
                rows: resultRows,
            })
        }
        
    }
    
    render() {
        const {classes} = this.props
        const {
            mode, 
            rows, 
            isShowTools
        } = this.state
        
        return (
            <MuiThemeProvider theme={theme}>
                <CssBaseline/>
                <div className={classes.root}>
                    {
                        rows.map(row => {
                            let RowView = rowTypes[_.findIndex(rowTypes, rowType => {return rowType.type == row.type})]
                            switch(mode) {
                                case 'edit':
                                    RowView = RowView.edit
                                    break
                                case 'preview':
                                    RowView = RowView.preview
                                    break
                            }
                            return (
                                <Row 
                                    mode={mode}
                                    key={row.id}
                                    id={row.id}
                                    onShowTools={this.onShowTools}
                                    isShowTools={isShowTools}
                                    selectRowHandler={this.addRow}
                                >
                                    <RowView 
                                        elements={row.elements} 
                                        row={row}
                                    />
                                </Row>
                            )
                        })
                    }
                </div>
            </MuiThemeProvider>
        )        
    }
}

const styles = theme => ({
    root: {        
        //backgroundColor: theme.palette.background.paper,
        backgroundColor: grey[50],
        marginTop: 50,  //TODO mobile
    },
})

const theme = createMuiTheme({
    palette: {
        primary: grey,
        secondary: {
            main: grey[700],
        },
    },
})

export default withStyles(styles)(App)